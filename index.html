<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”å¸ƒå¾€äº‹åœ°å›¾</title>
    
    <link rel="stylesheet" href="css/leaflet.css" />
    
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            background: #f0f0f0;
        }
        /* Leaflet Info å’Œ Legend æ ·å¼ */
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border-radius: 2px;
        }
        /* åŠ è½½æç¤ºå’Œå¤´éƒ¨æ ·å¼ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            text-align: center;
        }
        .header {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        /* Popup å†…å®¹æ ·å¼ */
        .popup-content h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .popup-content p {
            margin: 8px 0;
        }

        /* ---------------------------------------------------- */
        /* æ–°å¢ï¼šè‡ªå®šä¹‰ Marker æ ·å¼åŸºç¡€ï¼ˆç”¨äº L.divIconï¼‰         */
        /* ---------------------------------------------------- */
        .custom-marker {
            /* ç¡®ä¿ DivIcon å®¹å™¨ä¸å¸¦é»˜è®¤èƒŒæ™¯æˆ–è¾¹æ¡† */
            background: none !important; 
            border: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å¡”å¸ƒå¾€äº‹åœ°å›¾</h1>
    </div>
    
    <div id="map"></div>
    <div id="loading" class="loading">æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</div>

    <script src="js/leaflet.js"></script>
    
    <script>
        // ä¿®å¤Leafletçš„å›¾æ ‡è·¯å¾„é—®é¢˜ (ç”¨äºé»˜è®¤ Markerï¼Œä½† PointToLayer ä¼šè¦†ç›–)
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'images/marker-icon-2x.png',
            iconUrl: 'images/marker-icon.png',
            shadowUrl: 'images/marker-shadow.png',
        });

        // åˆå§‹åŒ–åœ°å›¾
        var map = L.map('map').setView([39.9, 116.3], 10);
        var geojsonLayer;

        // æ·»åŠ æœ¬åœ°åº•å›¾å›¾å±‚ - OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);


        // ====================================================================
        // ğŸ¯ æ–°å¢å‡½æ•°ï¼šæ ¹æ® GeoJSON å±æ€§åˆ›å»ºè‡ªå®šä¹‰æ ·å¼çš„ Marker
        // ====================================================================

        /**
         * æ ¹æ® GeoJSON çš„ simplestyle å±æ€§åˆ›å»ºè‡ªå®šä¹‰æ ·å¼çš„ Marker å›¾æ ‡
         * * @param {object} feature GeoJSON featureå¯¹è±¡
         * @param {L.LatLng} latlng Markerçš„ç»çº¬åº¦
         * @returns {L.Marker} å¸¦æœ‰è‡ªå®šä¹‰DivIconçš„Marker
         */
        function createStyledMarker(feature, latlng) {
            var props = feature.properties;
            
            // è¯»å– marker-color, marker-size, marker-symbol
            var color = props['marker-color'] || '#0070ff'; // é»˜è®¤è“è‰²
            var size = props['marker-size'] || 'medium';
            
            var iconSize;
            var markerRadius; // ç”¨äºè®¾ç½®åœ†ç‚¹çš„åŠå¾„

            switch (size.toLowerCase()) {
                case 'small':
                    markerRadius = 5;
                    break;
                case 'large':
                    markerRadius = 10;
                    break;
                case 'medium':
                default:
                    markerRadius = 7.5;
                    break;
            }
            
            iconSize = markerRadius * 2 + 4; // å®¹å™¨å¤§å° = ç›´å¾„ + è¾¹æ¡†

            // åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„åœ†å½¢å›¾æ ‡ (DivIcon)
            var customIcon = L.divIcon({
                className: 'custom-marker', // ä½¿ç”¨ CSS ä¸­çš„æ¸…é™¤æ ·å¼
                html: '<div style="background-color: ' + color + '; ' +
                      'width: ' + (markerRadius * 2) + 'px; ' +
                      'height: ' + (markerRadius * 2) + 'px; ' +
                      'border-radius: 50%; ' +
                      'border: 2px solid #fff; ' +
                      'box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                iconSize: [iconSize, iconSize], 
                iconAnchor: [iconSize / 2, iconSize / 2] // é”šç‚¹å±…ä¸­
            });
            
            return L.marker(latlng, { icon: customIcon });
        }


        // åŠ è½½æœ¬åœ°GeoJSONæ•°æ®
        fetch('data/Tarbes_meme_map.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½åœ°å›¾æ•°æ®æ–‡ä»¶ (' + response.status + ')');
                }
                return response.json();
            })
            .then(data => {
                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').style.display = 'none';
                
                // åˆ›å»ºGeoJSONå›¾å±‚
                geojsonLayer = L.geoJSON(data, {
                    
                    // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ pointToLayer å¤„ç† Point ç±»å‹è¦ç´ ï¼Œè¯»å– marker-color
                    pointToLayer: createStyledMarker,
                    
                    // style å‡½æ•°åªåº”ç”¨äº Polygon/Polyline (é Point ç±»å‹)
                    style: function(feature) {
                        if (feature.geometry.type !== 'Point') {
                            // ä¸º Polygon/Polyline è®¾ç½®é¢œè‰²
                            var color = getColor(feature.properties.value || 0);
                            return {
                                fillColor: color,
                                weight: 2,
                                opacity: 1,
                                color: 'white',
                                dashArray: '3',
                                fillOpacity: 0.7
                            };
                        }
                        // Point ç±»å‹è¿”å›ç©ºæ ·å¼ï¼Œç”± pointToLayer å¤„ç†
                        return {};
                    },
                    onEachFeature: function(feature, layer) {
                        // é¼ æ ‡æ‚¬åœæ•ˆæœ (å¯¹ Polygon/Polyline å’Œ Marker éƒ½æœ‰æ•ˆ)
                        layer.on({
                            mouseover: highlightFeature,
                            mouseout: resetHighlight,
                            click: zoomToFeature
                        });
                        
                        // æ·»åŠ å¼¹å‡ºä¿¡æ¯
                        if (feature.properties) {
                            var popupContent = '<div class="popup-content">';
                            if (feature.properties.name) {
                                popupContent += '<h3>' + feature.properties.name + '</h3>';
                            }
                            if (feature.properties.description) {
                                popupContent += '<p>' + feature.properties.description + '</p>';
                            }
                            // æ·»åŠ å…¶ä»–å±æ€§
                            var excludedProps = ['name', 'value', 'description', 'marker-color', 'marker-size', 'marker-symbol'];
                            for (var key in feature.properties) {
                                if (feature.properties.hasOwnProperty(key) && !excludedProps.includes(key)) {
                                    popupContent += '<p><strong>' + key + ':</strong> ' + feature.properties[key] + '</p>';
                                }
                            }
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(map);

                // é€‚åº”åœ°å›¾èŒƒå›´
                var bounds = geojsonLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds);
                    map.setMaxBounds(bounds.pad(0.1));
                }

                map.setMaxZoom(18);

                // æ·»åŠ å›¾ä¾‹ (å¦‚æœGeoJSONä¸­åŒ…å«valueå±æ€§)
                if (data.features.some(f => f.properties.value !== undefined)) {
                     addLegend();
                }
               
            })
            .catch(error => {
                console.error('åŠ è½½GeoJSONå¤±è´¥:', error);
                document.getElementById('loading').innerHTML = 
                    'åŠ è½½åœ°å›¾æ•°æ®å¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥ data/Tarbes_meme_map.geojson æ–‡ä»¶æ˜¯å¦å­˜åœ¨';
            });

        // é¢œè‰²å‡½æ•° (ç”¨äº Polygon/Polyline)
        function getColor(d) {
            var value = typeof d === 'number' ? d : 0;
            return value > 1000 ? '#800026' :
                   value > 500  ? '#BD0026' :
                   value > 200  ? '#E31A1C' :
                   value > 100  ? '#FC4E2A' :
                   value > 50   ? '#FD8D3C' :
                   value > 20   ? '#FEB24C' :
                   value > 10   ? '#FED976' :
                                  '#FFEDA0';
        }

        // é«˜äº®è¦ç´  (é€‚ç”¨äº Polygon/Polyline)
        function highlightFeature(e) {
            var layer = e.target;
            
            // åªæœ‰ Polygon/Polyline æ‰éœ€è¦è®¾ç½®æ ·å¼
            if (layer.feature && layer.feature.geometry.type !== 'Point') {
                layer.setStyle({
                    weight: 4,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.9
                });
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
            }
        }

        // é‡ç½®é«˜äº® (é€‚ç”¨äº Polygon/Polyline)
        function resetHighlight(e) {
            if (geojsonLayer && e.target.feature && e.target.feature.geometry.type !== 'Point') {
                geojsonLayer.resetStyle(e.target);
            }
        }

        // ç¼©æ”¾è‡³è¦ç´  (é€‚ç”¨äº Polygon/Polyline)
        function zoomToFeature(e) {
            var layer = e.target;
            if (layer.getBounds) {
                map.fitBounds(layer.getBounds(), { 
                    padding: [20, 20],
                    maxZoom: 16 
                });
            }
            // å¯¹äº Point è¦ç´ ï¼Œåªå±…ä¸­
            if (layer.getLatLng) {
                map.setView(layer.getLatLng(), 16);
            }
        }

        // æ·»åŠ å›¾ä¾‹
        function addLegend() {
            var legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                var grades = [0, 10, 20, 50, 100, 200, 500, 1000];
                var labels = [];
                var from, to;
                
                div.innerHTML = '<h4>æ•°å€¼å›¾ä¾‹</h4>';
                
                for (var i = 0; i < grades.length; i++) {
                    from = grades[i];
                    to = grades[i + 1];
                    
                    labels.push(
                        '<i style="background:' + getColor(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+')
                    );
                }
                
                div.innerHTML += labels.join('<br>');
                return div;
            };
            
            legend.addTo(map);
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜åœ°å›¾
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });

        // æ·»åŠ å…¨å±åˆ‡æ¢æŒ‰é’®ï¼ˆéœ€è¦ L.control.fullscreen æ’ä»¶ï¼‰
        // å‡è®¾æ‚¨å·²ç»å¼•å…¥äº†æ­¤æ’ä»¶çš„ JS/CSS
        if (L.control.fullscreen) {
             L.control.fullscreen({
                position: 'topleft',
                title: 'åˆ‡æ¢å…¨å±',
                titleCancel: 'é€€å‡ºå…¨å±',
                forceSeparateButton: true
            }).addTo(map);
        }

    </script>
</body>
</html>
